package dal.dao;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import biz.DtoFactory;
import biz.dto.PresenceDto;
import biz.objects.Company;
import biz.objects.Contact;
import biz.objects.Participation;
import biz.objects.Presence;
import dal.DalBackEndServices;
import dal.dao.schema.PresenceSchema;
import ihm.utils.Logger;

class PresenceDaoImpl extends AbstractDao implements PresenceDao, PresenceSchema {

  /**
   * Insert Presence auto generated query.
   */
  private static final String PRESENCE_CREATE_QUERY =
      "INSERT INTO " + TABLE + " (" + String.join(",", FIELDS_MAP) + ") VALUES ("
          + String.join(",", Collections.nCopies(FIELDS_MAP.size(), "?")) + ") RETURNING *";

  /**
   * A compiled expression finding all fields from the table presence in database.
   */
  private static final String PRESENCE_FIND_QUERY = "SELECT * FROM " + TABLE + " WHERE ";

  PresenceDaoImpl(DalBackEndServices dal, DtoFactory factory) {
    super(dal, factory);
  }

  @Override
  public PresenceDto create(Presence presence) {
    Logger.log("PresenceDaoImpl", "create", "Creating presence");

    try {
      PreparedStatement stmt = this.dal.prepareStatement(PRESENCE_CREATE_QUERY);

      stmt.setInt(1, presence.getParticipation().getJe().getDayYear());
      stmt.setInt(2, presence.getCompany().getPk());
      stmt.setInt(3, presence.getContact().getPk());

      Logger.log("PresenceDaoImpl", "create", "Presence Saved");

      ResultSet rs = stmt.executeQuery();

      if (!rs.next()) {
        rs.close();
        return null;
      }

      presence = populateDto(rs);

      return presence;
    } catch (Exception exc) {
      exc.printStackTrace();
      Logger.log("CompanyDaoImpl", "create",
          "registration of : " + presence.getParticipation().getJe().getDayYear() 
          + ", company :" + presence.getCompany().getCompanyName() 
          + ", contact :" + presence.getContact().getEmail() 
          + " failed : " + exc.getMessage());
      return null;
    }
  }

  /**
   * Get All the presence for the given year.
   *
   * @return {@link List} of {@link PresenceDto}
   */
  @Override
  public List<PresenceDto> findByYear(int year) {
    List<PresenceDto> presences = new ArrayList<>();
    try {
      PreparedStatement ps = this.dal.prepareStatement(
          PRESENCE_FIND_QUERY + FIELD_PRESENCE_PARTICIPATION_YEAR + " = ?");
      ResultSet rs = ps.executeQuery();

      while (!rs.next()) {
        presences.add(populateDto(rs));
      }
      rs.close();

    } catch (SQLException exception) {
      Logger.log("PresenceDaoImpl", "findByYear", exception.getMessage());
    }
    return presences;
  }

  /**
   * Create an instance of DTO presence based on result set.
   *
   * @param rs {@link ResultSet} coming directly from database
   * @return a {@link Presence} object with the information of the {@link ResultSet}
   * @throws SQLException if an error occurs during result set access
   */
  private Presence populateDto(ResultSet rs) throws SQLException {
    Presence presence = (Presence) this.factory.getPresence();

    CompanyDao companyDao = new CompanyDaoImpl(this.dal, this.factory);
    Company company =
        (Company) companyDao.findByPk(rs.getInt(FIELD_PRESENCE_COMPANY_NUMBER));
    presence.setCompany(company);
    
    ParticipationDao participationDao = new ParticipationDaoImpl(this.dal, this.factory);
    Participation participation =
        (Participation) participationDao.findByYear(rs.getInt(FIELD_PRESENCE_PARTICIPATION_YEAR));
    presence.setParticipation(participation);
    
    ContactDao contactDao = new ContactDaoImpl(this.dal, this.factory);
    Contact contact =
        (Contact) contactDao.findByPk(rs.getInt(FIELD_PRESENCE_CONTACT_NUMBER));
    presence.setContact(contact);

    return presence;
  }


}
